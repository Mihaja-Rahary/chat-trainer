<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Chat Trainer</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
  body { margin:0; font-family:'Roboto', sans-serif; background:#0f0f0f; color:#eee; display:flex; height:100vh; }
  #fans { width:260px; border-right:1px solid #333; padding:10px; overflow:auto; background:#111; }
  .fan { padding:8px; cursor:pointer; border-bottom:1px solid #222; display:flex; align-items:center; gap:8px; }
  .fan:hover { background:#222; }
  .fan img { width:30px; height:30px; border-radius:50%; }
  #chatZone { flex:1; display:flex; flex-direction:column; }
  #chat { flex:1; padding:10px; overflow:auto; }
  #inputZone { display:flex; border-top:1px solid #333; padding:10px; }
  input { flex:1; padding:8px; background:#111; color:white; border:1px solid #333; border-radius:5px; }
  button { margin-left:8px; padding:8px 12px; border:none; border-radius:5px; cursor:pointer; background:#ff5f6d; color:#fff; transition:0.3s; }
  button:hover { background:#ff8a75; }
  #stats, #adminSection { font-size:12px; padding:5px; background:#111; border-top:1px solid #222; }
  .chat-bubble { max-width:60%; padding:8px 12px; border-radius:15px; margin:5px 0; display:inline-block; }
  .from-agent { background:#ff5f6d; align-self:flex-end; }
  .from-fan { background:#444; align-self:flex-start; }
  .chat-msg { display:flex; align-items:flex-end; gap:8px; }
  .chat-msg img { width:30px; height:30px; border-radius:50%; }
  .tip { background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:8px; margin:5px auto; max-width:300px; animation: floatTip 2s ease infinite alternate; font-size:12px; }
  @keyframes floatTip { 0% { transform:translateY(0);} 100% { transform:translateY(-5px);} }
</style>
</head>
<body>

<div id="fans">
  <button onclick="createFan()">+ Nouveau fan</button>
  <div id="fanList"></div>
</div>

<div id="chatZone">
  <div id="chat"></div>

  <div id="inputZone">
    <input id="msg" placeholder="Votre message..." />
    <button onclick="send()">Envoyer</button>
  </div>

  <div id="stats"></div>
  <div id="adminSection">
    <h4>Admin Dashboard</h4>
    <div id="adminStats"></div>
  </div>
</div>

<script>
// --- Gestion rÃ´les ---
const username = localStorage.getItem("username");
const role = localStorage.getItem("role");

if(!username) {
  alert("Connectez-vous d'abord");
  window.location.href="login.html";
}

// cacher adminSection si chatter
if(role === "chatter") document.getElementById("adminSection").style.display="none";

// --- Faux fans & personas ---
let fans = [];
let currentFan = null;
let lastAgentMessageTime = null;
let responseTimes = [];
let totalMessages = 0;

const FIRSTNAMES = ["alex","kevin","julien","nico","tom","max","leo","antoine","sam","david","ryan"];
const WORDS = ["love","dark","boss","king","player","wild","solo","dream","night","secret","heart","wolf","fire","shadow","mood"];
const SEPARATORS = ["", "", "", "_", ".", ""];

const AVATARS = [
  "https://i.pravatar.cc/50?img=1",
  "https://i.pravatar.cc/50?img=2",
  "https://i.pravatar.cc/50?img=3",
  "https://i.pravatar.cc/50?img=4",
  "https://i.pravatar.cc/50?img=5"
];

const PERSONAS = [
  "lonely and emotional",
  "cold and suspicious",
  "talkative and playful",
  "shy and insecure",
  "direct and impatient",
  "curious but cautious"
];

function randomFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function generatePseudo(){
  const type = Math.floor(Math.random()*5);
  switch(type){
    case 0: return randomFrom(FIRSTNAMES)+Math.floor(Math.random()*99);
    case 1: return randomFrom(WORDS)+randomFrom(SEPARATORS)+randomFrom(WORDS)+Math.floor(Math.random()*100);
    case 2: return randomFrom(FIRSTNAMES)+randomFrom(SEPARATORS)+Math.floor(Math.random()*999);
    case 3: return randomFrom(WORDS)+randomFrom(WORDS);
    case 4: return randomFrom(FIRSTNAMES)+"_"+(1980+Math.floor(Math.random()*25));
  }
}

// --- CrÃ©er un fan ---
function createFan(){
  const fan = {
    id: Date.now().toString(),
    pseudo: generatePseudo(),
    persona: randomFrom(PERSONAS),
    avatar: randomFrom(AVATARS),
    messages:[{from:"fan", text:"Salut ðŸ™‚", time:Date.now()}],
    createdAt:Date.now()
  };
  fans.push(fan);
  loadFans();
  if(role==="admin") updateAdminStats();
}

// --- Afficher la liste ---
function loadFans(){
  const list = document.getElementById("fanList");
  list.innerHTML="";
  fans.forEach(f=>{
    const div = document.createElement("div");
    div.className="fan";
    div.innerHTML=`<img src="${f.avatar}"/> ${f.pseudo}`;
    div.onclick=()=>selectFan(f.id);
    list.appendChild(div);
  });
}

// --- SÃ©lection fan ---
function selectFan(id){
  currentFan = fans.find(f=>f.id===id);
  renderChat();
}

// --- Afficher chat ---
function renderChat(){
  const chat = document.getElementById("chat");
  chat.innerHTML="";
  if(!currentFan) return;
  currentFan.messages.forEach(m=>{
    const div = document.createElement("div");
    div.className="chat-msg";
    const bubble = document.createElement("div");
    bubble.className="chat-bubble "+(m.from==="agent"?"from-agent":"from-fan");
    bubble.innerText=m.text;
    const avatar = document.createElement("img");
    avatar.src = m.from==="agent"?"https://i.pravatar.cc/50?img=6":currentFan.avatar;
    div.appendChild(avatar);
    div.appendChild(bubble);
    chat.appendChild(div);
  });
  chat.scrollTop = chat.scrollHeight;
}

// --- Envoyer message ---
async function send(){
  if(!currentFan) return alert("Choisis un fan.");
  const input = document.getElementById("msg");
  const text = input.value;
  if(!text) return;
  input.value="";
  totalMessages++;

  currentFan.messages.push({from:"agent",text,time:Date.now()});
  renderChat();
  lastAgentMessageTime = Date.now();

  // --- RÃ©ponse simulÃ©e ---
  const reply = simulateFanReply(text,currentFan.persona);
  setTimeout(()=>{
    const fanTime = Date.now();
    const delay = fanTime - lastAgentMessageTime;
    responseTimes.push(delay);

    currentFan.messages.push({from:"fan",text:reply,time:fanTime});
    renderChat();
    updateStats();
    if(role==="admin") updateAdminStats();
  },1000+Math.random()*1000);
}

// --- Simulation IA basique ---
function simulateFanReply(msg, persona){
  // simple variante alÃ©atoire selon persona
  const replies = [
    "Ah oui ? ðŸ˜",
    "Je voisâ€¦",
    "Hmmâ€¦ je ne sais pas trop ðŸ˜…",
    "Dis mâ€™en plus !",
    "Tu me surprends lÃ  ðŸ˜‰",
    "Vraiment ? ðŸ˜³",
    "Continueâ€¦ ðŸ˜Œ"
  ];
  return randomFrom(replies);
}

// --- Stats agent ---
function updateStats(){
  const avg = responseTimes.reduce((a,b)=>a+b,0)/(responseTimes.length||1);
  document.getElementById("stats").innerText="Messages: "+totalMessages+" | Temps moyen rÃ©ponse: "+Math.round(avg/1000)+"s";
}

// --- Admin dashboard ---
function updateAdminStats(){
  const totalFans = fans.length;
  const totalMessagesAll = fans.reduce((acc,f)=>acc+f.messages.length,0);
  document.getElementById("adminStats").innerHTML=`Total fans: ${totalFans}<br>Total messages: ${totalMessagesAll}`;
}

// --- Initial load ---
loadFans();
if(role==="admin") updateAdminStats();
</script>

</body>
</html>
